---
- name: Create weather DB
  hosts: master  #master... Master of puppets i`m pulling your strings...
  become: true
  become_user: postgres
  gather_facts: true
  vars_files:
    - vars/user_vars.yml

  tasks:

  - name: Create weather db
    community.postgresql.postgresql_db:
      name: weather
      encoding: 'UTF-8'
      lc_collate: 'ru_RU.UTF-8'
      lc_ctype: 'ru_RU.UTF-8'
      state: present

  - name: Create weather role for db
    postgresql_user: 
      db: weather
      user: "{{ dbuser }}"
      password: "{{ dbpassword }}"
      priv: ALL
      state: present

  - name: Copy file
    ansible.builtin.copy:
      src: ./init.sql #edit path to init.sql file
      dest: /var/lib/postgresql/init.sql #default DB path
      mode: '0666'

  - name: Importing weather db
    ansible.builtin.shell:
      psql weather < /var/lib/postgresql/init.sql

  - name: Grant usage of schema to weather role
    community.postgresql.postgresql_privs:
      database: weather
      state: present
      privs: USAGE
      type: schema
      roles: "{{ dbuser }}"
      objs: public

  - name: Grant table permissions for "{{ dbuser }}" role
    community.postgresql.postgresql_privs: 
      database: weather
      schema: public
      state: present
      privs: SELECT,INSERT,UPDATE
      type: table
      roles: "{{ dbuser }}"
      grant_option: no
      objs: ALL_IN_SCHEMA

  - name: Grant permissions for "{{ dbuser }}" role
    community.postgresql.postgresql_privs: 
      database: weather
      schema: public
      state: present
      privs: USAGE
      type: sequence
      roles: "{{ dbuser }}"
      grant_option: no
      objs: ALL_IN_SCHEMA